<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¢ãƒ—ãƒª</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- htmx -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
  
  <!-- Custom Styles -->
  <style>
    body {
      background-color: #f8f9fa;
    }
    
    .task-card {
      transition: box-shadow 0.3s ease;
    }
    
    .task-card:hover {
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .header-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 0.5rem;
      padding: 2rem;
      margin-bottom: 2rem;
    }
    
    @media (max-width: 768px) {
      .header-section {
        padding: 1.5rem;
      }
      
      .header-section h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Header Section -->
    <header class="header-section mb-4">
      <h1 class="display-4 mb-2">ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¢ãƒ—ãƒª</h1>
      <p class="lead mb-0">ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ã—ã¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è»¢è¨˜ã—ã¾ã™</p>
    </header>
    
    <!-- Form Section Container -->
    <main>
      <div id="form-container" x-data="taskApp()">
        <!-- Task Input Form -->
        <form id="task-form" class="mb-4">
          <!-- Task Rows (Dynamic) -->
          <template x-for="(task, index) in tasks" :key="index">
            <div class="card mb-3 task-card shadow-sm">
              <div class="card-body">
                <div class="row g-3">
                  <!-- Task Name Field -->
                  <div class="col-12 col-md-4">
                    <label :for="'taskName-' + index" class="form-label fw-semibold">
                      <i class="bi bi-check-circle"></i> ã‚¿ã‚¹ã‚¯å <span class="text-danger">*</span>
                    </label>
                    <input 
                      type="text" 
                      class="form-control form-control-lg" 
                      :id="'taskName-' + index"
                      :name="'taskName[]'"
                      x-model="task.name"
                      placeholder="ä¾‹: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè³‡æ–™ä½œæˆ">
                    <small class="form-text text-muted">â€» å­ã‚¿ã‚¹ã‚¯ã¯ã€Œ>ã€ã§é–‹å§‹</small>
                  </div>
                  
                  <!-- Due Date Field -->
                  <div class="col-12 col-sm-6 col-md-3">
                    <label :for="'dueDate-' + index" class="form-label fw-semibold">
                      <i class="bi bi-calendar"></i> æœŸé™
                    </label>
                    <input 
                      type="date" 
                      class="form-control form-control-lg" 
                      :id="'dueDate-' + index"
                      :name="'dueDate[]'"
                      x-model="task.dueDate"
                      placeholder="æœŸé™æ—¥ã‚’é¸æŠ">
                  </div>
                  
                  <!-- Task Detail Field -->
                  <div class="col-12 col-md-4">
                    <label :for="'taskDetail-' + index" class="form-label fw-semibold">
                      <i class="bi bi-file-text"></i> ã‚¿ã‚¹ã‚¯è©³ç´°
                    </label>
                    <textarea 
                      class="form-control" 
                      :id="'taskDetail-' + index"
                      :name="'taskDetail[]'"
                      x-model="task.detail"
                      rows="3"
                      placeholder="è©³ç´°æƒ…å ±ã‚’å…¥åŠ›ï¼ˆæœ€å¤§3,500æ–‡å­—ï¼‰"></textarea>
                  </div>
                  
                  <!-- Delete Button -->
                  <div class="col-12 col-sm-6 col-md-1 d-flex align-items-end">
                    <button 
                      type="button" 
                      class="btn btn-danger w-100"
                      @click="removeTask(index)"
                      :disabled="tasks.length === 1"
                      title="ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤">
                      <span class="d-none d-md-inline">å‰Šé™¤</span>
                      <span class="d-md-none">ğŸ—‘ï¸ å‰Šé™¤</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </template>
          
          <!-- Add Task Row Button -->
          <div class="mb-4">
            <button 
              type="button" 
              class="btn btn-outline-secondary btn-lg"
              @click="addTask()">
              <span class="fs-5">+</span> è¡Œã‚’è¿½åŠ 
            </button>
          </div>
          
          <!-- Action Buttons -->
          <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-4">
            <button 
              type="button" 
              class="btn btn-primary btn-lg px-5"
              @click="submitTasks()"
              :disabled="loading">
              <span x-show="!loading">ğŸš€ å‡¦ç†é–‹å§‹ï¼</span>
              <span x-show="loading">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                å‡¦ç†ä¸­...
              </span>
            </button>
            <button 
              type="button" 
              class="btn btn-secondary btn-lg px-4"
              @click="clearTasks()"
              :disabled="loading">
              ğŸ—‘ï¸ ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
            </button>
          </div>
          
          <!-- Loading Indicator -->
          <div x-show="loading" class="text-center mb-4 p-4 bg-light rounded">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
              <span class="visually-hidden">å‡¦ç†ä¸­...</span>
            </div>
            <p class="mt-2 mb-0 fw-semibold">å‡¦ç†ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p>
          </div>
          
          <!-- Message Display -->
          <div x-show="message" 
               x-transition
               :class="messageClass"
               class="alert alert-dismissible fade show shadow-sm" 
               role="alert">
            <strong x-show="messageClass.includes('success')">âœ… æˆåŠŸï¼</strong>
            <strong x-show="messageClass.includes('danger')">âŒ ã‚¨ãƒ©ãƒ¼</strong>
            <span x-text="message"></span>
            <button type="button" class="btn-close" @click="message = ''" aria-label="é–‰ã˜ã‚‹"></button>
          </div>
        </form>
      </div>
    </main>
    
    <!-- Alpine.js Data Store Script -->
    <script>
      function taskApp() {
        return {
          tasks: [
            { name: '', dueDate: '', detail: '' }
          ],
          loading: false,
          message: '',
          messageClass: '',
          
          addTask() {
            this.tasks.push({ name: '', dueDate: '', detail: '' });
          },
          
          removeTask(index) {
            if (this.tasks.length > 1) {
              this.tasks.splice(index, 1);
            }
          },
          
          clearTasks() {
            this.tasks = [{ name: '', dueDate: '', detail: '' }];
            this.message = '';
          },
          
          submitTasks() {
            // Set loading state
            this.loading = true;
            this.message = '';
            
            // Serialize form data
            const taskData = this.tasks.map(task => ({
              name: task.name || '',
              dueDate: task.dueDate || '',
              detail: task.detail || ''
            }));
            
            // Use google.script.run to call server-side function
            google.script.run
              .withSuccessHandler((result) => {
                console.log('Success result:', result);
                
                // Display result message
                if (result.success) {
                  this.messageClass = 'alert-success';
                  this.message = result.message;
                  
                  // Clear tasks on success
                  this.clearTasks();
                  
                  // Auto-hide success message after 3 seconds
                  setTimeout(() => {
                    this.message = '';
                  }, 3000);
                } else {
                  this.messageClass = 'alert-danger';
                  this.message = result.message;
                }
                
                this.loading = false;
              })
              .withFailureHandler((error) => {
                console.error('Failure error:', error);
                this.messageClass = 'alert-danger';
                this.message = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
                this.loading = false;
              })
              .processTaskList(taskData);
          }
        }
      }
    </script>
  </div>
  
  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
